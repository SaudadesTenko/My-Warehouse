## 发票识别


##### 一、了解深度学习
```
一般深度学习做图片分类的入门教材是MNIST或CIFAR-10（tensorflow或者darknet的yolo深度学习模型，掌握好Keras这个工具,并且搭建一个用于图像分类的通用框架，以后做其他图像分类项目也可以得心应手)
```
##### 二、理解梯度下降算法
##### 三、理解图像的数字表示
##### 四、环境：
```
python3.6
依赖项安装：pip install -r requirements.txt -i
https://pypi.tuna.tsinghua.edu.cn/simple 
有GPU环境的可修改安装requirements.txt对应版本的tensorflow-gpu，config.py文件中控制GPU的开关
```
##### 五、模型架构：
```
YOLOv3 + CRNN + CTC
模型下载地址：链接：https://pan.baidu.com/s/1bjtd3ueiUj3rt16p2_YQ2w
```

##### 六、测试demo：
```
工具：postman（自行下载安装）
```


##### 七、启动识别服务(web接口服务)：
```
./api_invoice/main.py
开启的是8888端口,暂时未做配置化,可以直接在main.py中修改
```

##### 八、访问demo：
```
访问http://128.0.0.1:8888/invoice/index
选择上传图片,会识别出来图片并将结果显示在页面上
并显示识别的方法和识别定位的图片
```
##### 九、访问接口:
```
http://127.0.0.1:8888/invoice/url?url=http%3A%2F%2Fclub2.autoimg.cn%2Falbum%2Fg13%2FM0F%2FA4%2FA3%2Fuserphotos%2F2015%2F10%2F10%2F21%2F500_wKgH1FYZE2mALP-JAAJQY1pp49o236.jpg
传入图片连接,返回json数据
例如: { "cardno": "130102198707041249", "vinno": "LSGHD5289FD298030", "engineno": "152306132", "price": "¥61500.00" }
```


##### 十、代码执行过程说明：
```
使用tornado启动web服务,json格式化数据
对图片做处理,opencv,PIL,找到需要识别的局部图片并截取出来
使用darknet的yolo定位的方法,标识一批样本中关键数据的局部图片的位置
然后进行训练
训练完成后会得出一个权重文件
改造darknet的代码
为了能更快处理,在darknet里面启动了一个web服务
可以传入图片地址(服务器绝对地址,无后缀)
识别后返回图片中关键局部位置的坐标点
再使用坐标点将图片的关键部位切割出来
使用二值化加上轮廓等方法找到图片中最大方格,然后找到四个点
对四个点对应的四边形进行矫正,变成正方形,使得字体不会是歪的
检查长宽,处理横竖图片问题,这里还可以改进优化
缩放到固定大小
生成一张翻转的图片,暂时无法确定是否倒过来的,所以做识别两次的处理,可以优化
按照比例切出对应识别区域
把这个局部的图片切割出来
```


```
缺点：部分图片的方格不完整,图片打印的比较歪,明暗度差异的问题会导致识别准确率下降
```

##### 十一、图像处理方式：
```
注：图片定位切割完成之后,做正向反向识别
```

1、使用机器识别

```
先将图片再次切割,根据灰度值和波峰波谷算法将每个字符切割开
使用训练好的但字符模型镜像识别,多个不同的模型,依次进行识别
```

2、使用tesseract识别

```
原图识别
灰度图识别
默认阈值二值化识别 
批量默认阈值二值化识别
遍历阈值二值化识别
识别结果校验
如果不通过校验,则继续往下走
```


##### 十二、识别率校验：
```
将图片网络地址放到img.txt中,文件放到data/invoice目录下
执行ipi_invoice/test.py,将文件导入到数据库
然后删除img.txt文件
继续执行执行ipi_invoice/test.py,将会逐个识别并将结果记录到数据库,
通过sql可以判断出来识别率
```

##### 十三、模型训练
```
为尽可能提高训练模型识别率，将图片做相应处理，剔除噪声较多的图片，尤其是有相似噪声的图片
```


##### 十四、训练出的模型：
```
识别10个数字类别模型（用于身份证识别的 识别"数字+X"） 
识别"大写字母+数字" 26个类别的模型。 将发票系统中的数字，字母图片切割出来
先使用图像边缘和颜色定位，再识别字符车牌定位在predict方法中
字符识别使用的算法是opencv的SVM， opencv的SVM使用代码来自于opencv附带的sample，StatModel类和SVM类都是sample中的代码
```
